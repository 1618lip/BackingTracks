<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIDI Recorder with Backing Track</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/midi.js@latest/css/midi-js.css">
</head>
<body>
    <h1><b>JazzMIDIJam</b></h1>
    <h2>Jam along, playing a Jazz Standard</h2>
    <hr>
    <label for="backingTrack">Select Backing Track:</label>
    <input type="file" id="backingTrack" accept="audio/*">
    <br>
    <button id="startButton">Start Recording</button>
    <button id="stopButton" disabled>Stop Recording</button>

    <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/midi.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/midi-writer-js@latest"></script>

    <script>
        import MidiWriter from 'midi-writer-js';//Import the library needed
        document.addEventListener('DOMContentLoaded', function () {
            let recording = false;
            const recordedNotes = [];
            let midiOutput;

            WebMidi.enable().then(onEnabled).catch(err => alert(err));//if there's error, it'll catch it here

            function onEnabled() {
                const input = WebMidi.inputs[0];
                const MidiWriter = MidiWriterJS; // Assuming 'MidiWriterJS' is the correct alias
                midiOutput = new MidiWriter.Writer();

                if (input) {//this is input
                    alert('No MIDI input device detected.');//no input device detected
                    return;//RETURN SOMETHING HEREEEEEE
                }

                input.addListener('noteon', 'all', function (e) {
                    if (recording) {
                        recordedNotes.push({ name: e.note.name, velocity: e.velocity, time: e.timestamp });
                        midiOutput.track().note({
                            pitch: [e.note.name],
                            duration: '8', // Adjust the duration as needed
                            velocity: e.velocity,
                        });
                    }
                });
            }

            const startButton = document.getElementById('startButton'); //start button 
            const stopButton = document.getElementById('stopButton');
            const backingTrackInput = document.getElementById('backingTrack');

            startButton.addEventListener('click', function () {
                startRecording();
            });

            stopButton.addEventListener('click', function () {
                stopRecording();
            });

            function startRecording() {
                recording = true;
                recordedNotes.length = 0;
                midiOutput = new MidiWriter.Writer();
                startButton.disabled = true;
                stopButton.disabled = false;
            }

            function stopRecording() {
                recording = false;
                startButton.disabled = false;
                stopButton.disabled = true;
            }

            // Play the selected backing track
            backingTrackInput.addEventListener('change', function () {
                const backingTrack = backingTrackInput.files[0];

                if (backingTrack) {
                    const audio = new Tone.Player(URL.createObjectURL(backingTrack)).toDestination();
                    audio.sync().start(0);
                } else {
                    alert('Please select a backing track.');
                }
            });
        });
    </script>
</body>
</html>