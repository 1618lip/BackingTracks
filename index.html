<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="my_style.css">
<script type="text/javascript" src="lib/WebMIDIAPI.js"></script>
		<script type="text/javascript" src="js/midi.js"></script>
		<script type="text/javascript" src="js/synth.js"></script>
		<script type="text/javascript" src="js/pointerevents.js"></script>
</head>
<body>

<h2>JazzMIDIJam</h2>
<div class="row">
  <div class="left" style="background-color: rgba(213, 164, 87, 0.7);">
    <h2>Menu</h2>
    <input type="text" id="mySearch" onkeyup="filterSearch()" placeholder="Search Jazz Standard" title="Type in a category">
    <ul id="myMenu">
      <div class="tab">
        <li><a class="tabs" data-id="afoggyday">A Foggy Day</a></li>
        <li><a class="tabs" data-id="bluebossa">Blue Bossa</a></li>
        <li><a class="tabs" data-id="confirmation">Confirmation</a></li>
        <li><a class="tabs" data-id="donnalee">Donna Lee</a></li>
        <li><a class="tabs" data-id="giantsteps">Giant Steps</a></li>
        <li><a class="tabs" data-id="justfriends">Just Friends</a></li>
        <li><a class="tabs" data-id="recordame">Recordame</a></li>
      </div>
    </ul>
  </div>
  
  <div class="right" style="background-color:#ddd;">
    <div class="panel" id="afoggyday">
        <figure>
            <figcaption>Listen for a bit:</figcaption>
            <audio controls src="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/A_Foggy_Day.mp3">
                <a href="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/A_Foggy_Day.mp3"> Download audio </a>
            </audio>
        </figure>
        <button id="startRecording">Start Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
        <canvas id="canvas"></canvas>
		<div id="keybox">
			<div id="blackkeys">
				<span id="k61" class="black key"></span><span id="k63" class="black key"></span><span class="spacer"></span><span id="k66" class="black key"></span><span id="k68" class="black key"></span><span id="k70" class="black key"></span><span class="spacer"></span><span id="k73" class="black key"></span><span id="k75" class="black key"></span><span class="spacer"></span><span id="k78" class="black key"></span><span id="k80" class="black key"></span><span id="k82" class="black key"></span>
			</div>
			<span id="k60" class="white key"></span><span id="k62" class="white key"></span><span id="k64" class="white key"></span><span id="k65" class="white key"></span><span id="k67" class="white key"></span><span id="k69" class="white key"></span><span id="k71" class="white key"></span><span id="k72" class="white key"></span><span id="k74" class="white key"></span><span id="k76" class="white key"></span><span id="k77" class="white key"></span><span id="k79" class="white key"></span><span id="k81" class="white key"></span><span id="k83" class="white key"></span>
		</div>
		<select id="midiIn">
			<option>-no MIDI-</option>
		</select>
		<select id="kbd_oct">
			<option>+3</option>
			<option>+2</option>
			<option>+1</option>
			<option selected>normal</option>
			<option>-1</option>
			<option>-2</option>
			<option>-3</option>
		</select>
		<div id="record">
			<input type="button" value="record" id="record_btn" />
		</div>
		<div id="stop">
			<input type="button" value="stop recording" id="stop_btn" class="hidden" />
		</div>
		<div id="play">
			<input type="button" value="play" id="play_btn" class="hidden" />
		</div>
		<div id="stop_play">
			<input type="button" value="stop playing" id="stop_play_btn" class="hidden" />
		</div>
		<div id="time"></div>
		<div id="MIDIPlugin"></div>

		<script type="text/javascript" src="js/raf.js" ></script>
		<script type="text/javascript" src="js/stage.js" ></script>
		<script type="text/javascript" src="js/recorder.js" ></script>
    </div>
    
    <div class="panel" id="bluebossa">
        <figure>
            <figcaption>Listen for a bit:</figcaption>
            <audio controls src="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Blue_Bossa.mp3">
                <a href="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Blue_Bossa.mp3"> Download audio </a>
            </audio>
        </figure>
        <button id="startRecording">Start Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
        <label for="tempo">Tempo:</label>
<input type="number" id="tempo" value="120" min="1" max="300">
<button id="startRecording">Start Recording</button>
<button id="stopRecording" disabled>Stop Recording</button>
    </div>
    <div class="panel" id="confirmation">
        <figure>
            <figcaption>Listen for a bit:</figcaption>
            <audio controls src="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Confirmation.mp3">
                <a href="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Confirmation.mp3"> Download audio </a>
            </audio>
        </figure>
        <button id="startRecording">Start Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
    </div>
    <div class="panel" id="donnalee">
        <figure>
            <figcaption>Listen for a bit:</figcaption>
            <audio controls src="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Donna_Lee.mp3">
                <a href="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Donna_Lee.mp3"> Download audio </a>
            </audio>
        </figure>
        <button id="startRecording">Start Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
    </div>
    <div class="panel" id="giantsteps">
        <figure>
            <figcaption>Listen for a bit:</figcaption>
            <audio controls src="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Giant_Steps.mp3">
                <a href="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Giant_Steps.mp3"> Download audio </a>
            </audio>
        </figure>
        <button id="startRecording">Start Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
    </div>
    <div class="panel" id="justfriends">
        <figure>
            <figcaption>Listen for a bit:</figcaption>
            <audio controls src="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Just_Friends.mp3">
                <a href="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Just_Friends.mp3"> Download audio </a>
            </audio>
        </figure>
        <button id="startRecording">Start Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
    </div>
    <div class="panel" id="recordame">
        <figure>
            <figcaption>Listen for a bit:</figcaption>
            <audio controls src="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Recordame.mp3">
                <a href="https://github.com/1618lip/JazzMIDIJam/raw/main/BackingTracks/Recordame.mp3"> Download audio </a>
            </audio>
        </figure>
        <button id="startRecording">Start Recording</button>
        <button id="stopRecording" disabled>Stop Recording</button>
    </div>
  </div>
</div>
<main class="app-main">
  <noscript>
    This app requires JavaScript.
  </noscript>
  <h2>Plug in a MIDI keyboard and play away!</h2>
  <div id="controls">
    <span class="visually-hidden">.</span> <!-- for screen readers, or at least ChromeVox -->
    <fieldset class="ui-section">
      <legend>Input</legend>
      <span class="visually-hidden">.</span> <!-- for screen readers, or at least ChromeVox -->
      <h3>MIDI devices:</h3>
      <div id="midi-devices-area">
        <p id="loading-midi-devices-message" hidden>Loading...</p>
        <p id="no-midi-devices-message" hidden>No MIDI devices detected</p>
        <table id="midi-devices" aria-live="assertive"></table>
        <div id="midi-not-supported" hidden>
          <div class="error-message">
            This browser doesn't support MIDI access.
            Try using Chrome, or for other browsers, the
            <a href="https://jazz-soft.net/download/web-midi/">Jazz-Soft Web MIDI API extension</a>.
          </div>
          <button class="button-functional" id="demo-button">
            <span class="button-visual">
              <span id="demo-button-stop-text" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="1em">
                  <polygon points="0,0 0,100 100,100 100,0" fill="#FFF" class="fill-cc"/>
                </svg>
                Stop Demo
              </span>
              <span id="demo-button-start-text">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" height="1em">
                  <polygon points="0,0 0,100 100,50" fill="#FFF" class="fill-cc"/>
                </svg>
                Demo
              </span>
            </span>
          </button>
        </div>
        <div id="midi-access-failed" class="error-message" hidden>
          Failed to get MIDI access.
          <pre id="midi-access-failed-pre"></pre>
        </div>
      </div>
      <button id="troubleshoot-midi-input-button" class="popover-button" aria-haspopup="dialog" aria-expanded="false">
        <svg fill="currentColor" height="1em" viewBox="0 0 40 40" style="vertical-align: bottom;">
          <path
            d="m18.4 15v-3.4h3.2v3.4h-3.2z m1.6 18.4c7.3 0 13.4-6.1 13.4-13.4s-6.1-13.4-13.4-13.4-13.4 6.1-13.4 13.4 6.1 13.4 13.4 13.4z m0-30c9.2 0 16.6 7.4 16.6 16.6s-7.4 16.6-16.6 16.6-16.6-7.4-16.6-16.6 7.4-16.6 16.6-16.6z m-1.6 25v-10h3.2v10h-3.2z">
          </path>
        </svg>
        <u>MIDI device not showing up?</u>
      </button>
      <div id="troubleshoot-midi-input-popover" class="popover" hidden>
        <ul class="bulleted-list">
          <li>Make sure it's plugged into your computer and turned on.</li>
          <li>Try <a href="JavaScript:location.reload();">refreshing the page</a>.</li>
          <li>If that doesn't work, try unplugging it and plugging it back in.</li>
          <li>Try restarting your computer.</li>
        </ul>
        <div class="popover-arrow" data-popper-arrow></div>
      </div>
    </fieldset>
    <fieldset id="midi-exporting" class="ui-section">
      <legend>Export</legend>
      <div id="midi-exporting-clearing-controls">
        <button class="button-functional" id="export-midi-file-button" disabled aria-keyshortcuts="Ctrl+S Meta+S">
          <span class="button-visual">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" height="16">
              <g stroke-width="48.857" transform="translate(-3.631 -5.26) scale(.02225)">
                <path class="fill-cc" d="M301.429 312.422l372.684-76v103.929l-372.684 76z"/>
                <path class="fill-cc" d="M301.429 312.342h60v388.5h-60z"/>
                <ellipse class="fill-cc" cx="-165" cy="470.362" rx="125" ry="78" transform="matrix(.77274 -.20706 .24886 .92877 273.331 240.338)"/>
                <path class="fill-cc" d="M614.113 248.877h60v388.5h-60z"/>
                <ellipse class="fill-cc" cx="-165" cy="470.362" rx="125" ry="78" transform="matrix(.77274 -.20706 .24886 .92877 586.016 176.873)"/>
              </g>
              <path class="fill-cc" fill-rule="evenodd" d="M12.613 9.426c-.125.561-.347 1.012-1.258 1.585v1.165H9.033l3.485 3.838L16 12.176h-2.322v-2.75z"/>
            </svg>
            Save MIDI File
          </span>
        </button>
        <span id="name-or-message">
          <span id="no-notes-recorded-message" tabindex="0">&nbsp;- No notes recorded</span>
          <input type="text" id="recording-name-input" hidden/>
        </span>
        <span style="flex: 1"></span>
        <button class="button-functional" id="clear-button" disabled>
          <span class="button-visual">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" height="1em">
              <path class="fill-cc" d="M39.294 63.922c-5.91-.629-11.383-2.047-16.826-4.362-1.553-.66-4.626-2.198-5.977-2.99-4.008-2.35-7.353-4.936-10.39-8.035-1.735-1.77-3.048-3.3-3.357-3.91-.179-.353-.194-.438-.194-1.068 0-.613.018-.722.177-1.046.253-.513.57-.856 1.008-1.09.475-.252.926-.324 2.336-.373 3.303-.113 6.816-.77 10.27-1.922 4.89-1.63 8.196-3.606 10.903-6.513.618-.663 1.02-1.184 1.91-2.475.359-.52.69-.953.69-.953l4.228 2.034s-1.344 2.408-2.02 3.307c-4.042 5.372-11.416 9.262-20.634 10.885-.538.095-1.033.195-1.101.222-.104.042-.01.155.62.743 1.15 1.075 4.54 3.748 4.994 3.94.338.141.788.103 1.687-.143 1.986-.544 3.686-1.4 5.189-2.614.564-.455.587-.438.266.204-.452.905-1.627 2.507-2.997 4.088-.333.384-.605.716-.605.738 0 .023.609.336 1.353.696.744.36 1.808.9 2.364 1.2 1.165.63 1.74.81 2.58.81 1.035 0 2.04-.292 3.53-1.023 2.286-1.122 4.338-2.58 7.467-5.306l.309-.268-.127.368c-.446 1.296-1.746 3.565-3.897 6.802-.626.944-1.129 1.726-1.116 1.738.14.134 6.29 1.275 6.87 1.275.363 0 .552-.184 1.181-1.147 2.265-3.465 4.403-7.518 6.223-11.797.612-1.438.874-2.117 1.927-4.981.48-1.306.9-2.712.921-2.733.021-.022 4.55 1.83 4.58 1.856.067.058-1.255 3.727-2.134 5.923-2.08 5.193-4.356 9.659-7.103 13.94-.827 1.289-1.915 2.807-2.283 3.187-.646.667-1.569.926-2.822.793z"/>
              <path class="fill-cc-if-disabled" fill="red" d="M43.467 30.744c-6.402-2.85-11.665-5.19-11.696-5.202-.08-.028.23-.628.663-1.282 1.021-1.545 2.807-2.714 4.856-3.178.674-.153 2.13-.153 2.852 0 .852.181 1.344.37 3.945 1.513 4.675 2.054 7.29 3.248 7.909 3.61a7.62 7.62 0 013.693 5.22c.13.69.132 1.969.002 2.715-.099.563-.474 1.789-.548 1.787-.02-.001-5.274-2.333-11.676-5.183z"/>
              <path class="fill-cc" d="M47.999 20.662c-2.008-.897-3.687-1.666-3.731-1.709-.063-.06.954-2.015 4.703-9.043C51.8 4.608 53.853.83 53.996.665c.382-.44.681-.565 1.339-.56a4 4 0 012.68 1.052c.494.457.71.89.71 1.421 0 .367-.296 1.221-3.45 9.925-3.1 8.556-3.56 9.805-3.61 9.793-.008-.002-1.658-.737-3.666-1.634z"/>
            </svg>
            Clear
          </span>
        </button>
        <button class="button-functional" id="undo-clear-button" hidden>
          <span class="button-visual">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 511.983 511.983" height="1em">
              <path class="fill-cc" d="M255.983 160.199V63.986c-.007-5.891-4.788-10.661-10.679-10.655a10.666 10.666 0 00-5.983 1.844l-234.667 160c-4.866 3.321-6.119 9.957-2.798 14.823a10.667 10.667 0 002.798 2.798l234.667 160c4.873 3.311 11.507 2.045 14.817-2.828a10.674 10.674 0 001.844-5.983v-95.68c121.323 6.997 233.472 130.581 234.667 159.232v.619c.093 5.824 4.842 10.497 10.667 10.496 5.891 0 10.667-4.776 10.667-10.667v-.533c-2.133-118.122-91.946-280.469-256-287.253z"/>
            </svg>
            Undo Clear
          </span>
        </button>
      </div>
      <br>
      <div class="error-message" hidden id="recovery-error-message"></div>
      <!-- Modal libraries like to replace your buttons' id attributes apparently... -->
      <!-- Also there's no equivalent data-modal-hidden to make it not unhide the button if it's hidden -->
      <button class="button-functional show-recovery-button" disabled data-modal-disabled data-modal-open="recovery-modal-content">
        <span class="button-visual">
          <span class="loading-indicator"></span>
          Recover Recordings
        </span>
      </button>
      <div id="recovery-modal-content" hidden data-modal>
        <div data-modal-document>
          <h3>Recover Recordings</h3>
          <ul id="recoverables"></ul>
          <p id="recovery-empty-message" hidden>
            No more recordings to recover.
          </p>
        </div>
      </div>

    </fieldset>
    <!-- <div id="perspective-registration-container">
      <video id="perspective-registration-video">Video stream not available.</video>
      
      <svg id="perspective-registration-svg" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
          <g id="point-handle">
            <circle
              r="10" x="0" y="0"
              stroke-width="2"
              fill="#000"
              fill-opacity="0.3"
              stroke="#fff"
            />
            <line
              x1="0" y1="-10"
              x2="0" y2="10"
              stroke="white"
            />
            <line
              x1="-10" y1="0"
              x2="10" y2="0"
              stroke="white"
            />
          </g>
        </defs>
        <polygon
          id="perspective-registration-polygon"
          stroke="#29e"
          opacity="0.9"
          stroke-width="2"
          stroke-linejoin="round"
          fill="none"
          points="123,144 0,200 400,200 273,144"
        />
      </svg> -->

      <div id="fullscreen-target">
        <canvas id="midi-viz-canvas" class="element-to-transform"></canvas>
      </div>
    <!-- </div> -->
  </div>
</main>
<script>
  /*
  document.addEventListener('DOMContentLoaded', init);

let midiAccess;
let midiInput;
let recordedData = [];
let recording = false;
let playbackStartTime;
let tempo = 120; // Default tempo

async function init() {
  try {
    midiAccess = await navigator.requestMIDIAccess();
    midiInput = getFirstInput(midiAccess);

    if (midiInput) {
      console.log('MIDI input ready:', midiInput.name);
      midiInput.onmidimessage = handleMIDIMessage;
    } else {
      console.error('No MIDI input devices found.');
    }
  } catch (error) {
    console.error('Error accessing MIDI devices:', error);
  }

  document.getElementById('startRecording').addEventListener('click', startRecording);
  document.getElementById('stopRecording').addEventListener('click', stopRecording);
  document.getElementById('playBack').addEventListener('click', playBack);

  document.getElementById('tempo').addEventListener('input', updateTempo);
}

function getFirstInput(midiAccess) {
  for (const input of midiAccess.inputs.values()) {
    return input;
  }
  return null;
}

function handleMIDIMessage(event) {
  if (recording) {
    recordedData.push({ timestamp: event.timestamp, data: event.data });
  }
}

function startRecording() {
  recordedData = [];
  recording = true;
  playbackStartTime = null;
  tempo = parseInt(document.getElementById('tempo').value, 10);
  document.getElementById('startRecording').disabled = true;
  document.getElementById('stopRecording').disabled = false;
  document.getElementById('playBack').disabled = true;
}

function stopRecording() {
  recording = false;
  document.getElementById('startRecording').disabled = false;
  document.getElementById('stopRecording').disabled = true;
  document.getElementById('playBack').disabled = false;
}

function playBack() {
  if (recordedData.length === 0) {
    console.warn('No recorded MIDI data to play back.');
    return;
  }

  const output = midiAccess.outputs.values().next().value;
  if (!output) {
    console.error('No MIDI output devices found.');
    return;
  }

  playbackStartTime = performance.now();

  recordedData.forEach(({ timestamp, data }) => {
    const delay = (timestamp - recordedData[0].timestamp) * (60 / tempo);
    const playbackTime = playbackStartTime + delay;
    setTimeout(() => output.send(data, playbackTime), delay);
  });
}

function updateTempo() {
  tempo = parseInt(document.getElementById('tempo').value, 10);
}
*/

document.addEventListener('DOMContentLoaded', () => {
    const startRecordingButton = document.getElementById('startRecording');
    const stopRecordingButton = document.getElementById('stopRecording');
    const tempoInput = document.getElementById('tempo');

    let midiAccess;
    let midiStream;
    let startTime;
    let tempo = parseInt(tempoInput.value, 10);

    startRecordingButton.addEventListener('click', startRecording);
    stopRecordingButton.addEventListener('click', stopRecording);

    tempoInput.addEventListener('input', () => {
      tempo = parseInt(tempoInput.value, 10);
    });

    async function startRecording() {
      try {
        midiAccess = await navigator.requestMIDIAccess();
        const inputs = midiAccess.inputs.values();
        midiStream = inputs.next().value;

        if (!midiStream) {
          alert('No MIDI input devices found.');
          return;
        }

        // Start the recording timer
        startTime = performance.now();

        // Enable the stop button and disable the start button
        startRecordingButton.disabled = true;
        stopRecordingButton.disabled = false;

        // Add event listener to handle MIDI messages
        midiStream.onmidimessage = handleMIDIMessage;
      } catch (error) {
        console.error('Error starting MIDI recording:', error);
      }
    }

    function stopRecording() {
      // Disable the stop button and enable the start button
      startRecordingButton.disabled = false;
      stopRecordingButton.disabled = true;

      // Stop listening for MIDI messages
      midiStream.onmidimessage = null;
    }

    function handleMIDIMessage(event) {
      // Calculate the time elapsed since recording started
      const currentTime = performance.now();
      const elapsedTime = (currentTime - startTime) * (60 / tempo);

      // Get the MIDI message data
      const [status, note, velocity] = event.data;

      // Check if the message is a Note On event
      if (status === 144) {
        // Log the MIDI data (replace this with your MIDI recording logic)
        console.log(`Time: ${elapsedTime}ms, Note: ${note}, Velocity: ${velocity}`);
      }
    }
  });

//******************For Search Filter****************
// Cache out tab container, and all of the panels
const tabs = document.querySelector('.tab');
const panels = document.querySelectorAll('.panel');

// Add an event listener to the tabs container
tabs.addEventListener('click', handleClick);

// When a child element of `tabs` is clicked
function handleClick(e) {
 
  // Check to see if it's a tab
  if (e.target.matches('.tabs')) {

    // For every element in the `panels` node list, use `classList`
    // to remove the show class
    panels.forEach(panel => panel.classList.remove('show'));

    // "Destructure" the `id` from the button's data set
    const { id } = e.target.dataset;

    // Create a selector that will match the corresponding
    // panel with that id. We're using a template string to
    // help form the selector. Basically it says find me an element
    // with a "panel" class which also has an id that matches the id of
    // the button's data attribute which we just retrieved.
    const selector = `.panel[id="${id}"]`;

    // Select the `div` and, using classList, again add the
    // show class
    document.querySelector(selector).classList.add('show');
  }
}

function filterSearch() {
  var input, filter, ul, li, a, i;
  input = document.getElementById("mySearch");
  filter = input.value.toUpperCase();
  ul = document.getElementById("myMenu");
  li = ul.getElementsByTagName("li");
  for (i = 0; i < li.length; i++) {
    a = li[i].getElementsByTagName("a")[0];
    if (a.innerHTML.toUpperCase().indexOf(filter) > -1) {
      li[i].style.display = "";
    } else {
      li[i].style.display = "none";
    }
  }
}
//****************************************************
</script>
<script src="lib/FileSaver.js"></script>
	<script src="lib/popper-2.11.5.js"></script>
	<script src="lib/aria.modal.js"></script>
	<script src="lib/inert-polyfill.js"></script>
	<script src="lib/SimpleMidiInput.js"></script>
	<script src="lib/midifile/MIDIEvents.js"></script>
	<script src="lib/midifile/MIDIFile.js"></script>
	<script>JZZ={MIDI:{noteValue(){}}}</script>
	<script src="lib/JZZ.midi.GM.js"></script>
	<script src="lib/localforage.js"></script>
	<!-- <script src="lib/interact.min.js"></script> -->
	<script src="compiled/app.js"></script>
	<!-- <script src="compiled/3d.js"></script> -->
</body>
</html>