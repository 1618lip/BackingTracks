<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JazzMIDIJam</title>
  <!--MIDI libraries-->
  <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/midiwriter@latest/dist/MidiWriter.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/midi.js@latest"></script>
  <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>
  <script type="module">
    WebMidi.enable()
      .then(onEnabled)
      .catch(err => alert(err));

    let recordedNotes = [];

    function onEnabled() {
      if (WebMidi.inputs.length < 1) {
        document.body.innerHTML += "No MIDI input device detected.";
      } else {
        WebMidi.inputs.forEach((device, index) => {
          document.body.innerHTML += `${index}: ${device.name} <br>`;
        });

        const mySynth = WebMidi.inputs[0];
        mySynth.addListener("noteon", (e) => {
          document.body.innerHTML += `${e.note.name} <br>`;
          recordedNotes.push({ name: e.note.name, velocity: e.velocity, duration: 500 }); // Adjust the duration as needed
        });
      }
    }

    function playAudio() {
      const audioFileInput = document.getElementById('audioFile');
      const audioFile = audioFileInput.files[0];

      if (audioFile) {
        const audio = new Audio(URL.createObjectURL(audioFile));
        audio.play();
      } else {
        alert('Please select an audio file.');
      }
    }

    function saveMIDI() {
      const track = new MidiWriter.Track();
      recordedNotes.forEach((note) => {
        track.addEvent(new MidiWriter.NoteEvent({ pitch: [note.name], duration: 'T' + note.duration }));
      });

      const writer = new MidiWriter.Writer([track]);
      const midiBlob = new Blob([writer.buildFile()], { type: 'audio/midi' });
      const url = URL.createObjectURL(midiBlob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'recorded_midi.mid';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function visualizeMIDI() {
      MIDI.loadPlugin({
        soundfontUrl: "https://cdn.jsdelivr.net/npm/midi.js@latest/soundfont/",
        instrument: "acoustic_grand_piano",
        onsuccess: function () {
          const track = new MidiWriter.Track();
          recordedNotes.forEach((note) => {
            track.addEvent(new MidiWriter.NoteEvent({ pitch: [note.name], duration: 'T' + note.duration }));
          });

          const writer = new MidiWriter.Writer([track]);
          const midiData = writer.buildFile();
          const song = MIDI.Player.loadFile(midiData);
          MIDI.Player.stop();
          MIDI.Player.clearAnimation();
          MIDI.Player.start(song);
        },
      });
    }
  </script>
</head>
<body>
  <h1>WebMidi.js with Audio and MIDI.js</h1>
  <label for="audioFile">Select Backing Track:</label>
  <input type="file" id="audioFile" accept="audio/*">
  <br>
  <button onclick="playAudio()">Play Audio</button>
  <button onclick="saveMIDI()">Save MIDI</button>
  <button onclick="visualizeMIDI()">Visualize MIDI</button>
  <midi-player
  src="https://magenta.github.io/magenta-js/music/demos/melody.mid"
  sound-font visualizer="#myVisualizer">
</midi-player>
<midi-visualizer type="piano-roll" id="myVisualizer"></midi-visualizer>
</body>
</html>
